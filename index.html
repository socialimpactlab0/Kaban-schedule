<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åœ˜éšŠçœ‹æ¿</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  
  <style>
    * { font-family: 'Noto Sans TC', sans-serif; }
    
    /* è‡ªè¨‚æ»¾å‹•æ¢ */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    
    /* æ‹–æ‹‰æ¨£å¼ */
    .dragging { opacity: 0.5; transform: rotate(2deg); }
    .drag-over { border: 2px dashed #3b82f6 !important; background: #eff6ff !important; }
    .card-ghost { opacity: 0.4; }
    
    /* å‹•ç•« */
    .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
    .fade-enter-from, .fade-leave-to { opacity: 0; }
    
    .slide-enter-active, .slide-leave-active { transition: all 0.3s ease; }
    .slide-enter-from { transform: translateX(100%); opacity: 0; }
    .slide-leave-to { transform: translateX(100%); opacity: 0; }
    
    /* å¡ç‰‡æ¨£å¼ */
    .card-item { transition: all 0.2s ease; }
    .card-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    
    /* æ¨™ç±¤é¡è‰² */
    .label-red { background: #fee2e2; color: #dc2626; }
    .label-orange { background: #ffedd5; color: #ea580c; }
    .label-yellow { background: #fef9c3; color: #ca8a04; }
    .label-green { background: #dcfce7; color: #16a34a; }
    .label-blue { background: #dbeafe; color: #2563eb; }
    .label-purple { background: #f3e8ff; color: #9333ea; }
    
    /* Modal èƒŒæ™¯ */
    .modal-backdrop {
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }
    
    /* æ¬„ä½é¡è‰²æ¢ */
    .column-color-bar {
      height: 4px;
      border-radius: 4px 4px 0 0;
    }
    
    /* æ—¥æ›†æ ¼å­ */
    .calendar-day {
      min-height: 100px;
      transition: background 0.2s;
    }
    .calendar-day:hover {
      background: #f8fafc;
    }
    .calendar-today {
      background: #eff6ff;
      border: 2px solid #3b82f6;
    }
    
    /* ç”˜ç‰¹åœ– */
    .gantt-bar {
      height: 28px;
      border-radius: 4px;
      transition: all 0.2s;
    }
    .gantt-bar:hover {
      filter: brightness(1.1);
      transform: scaleY(1.1);
    }
    
    /* å³æ™‚åŒæ­¥æŒ‡ç¤ºå™¨ */
    .sync-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div id="app">
    <!-- è¼‰å…¥ä¸­ -->
    <div v-if="loading" class="fixed inset-0 bg-white flex items-center justify-center z-50">
      <div class="text-center">
        <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
        <p class="text-gray-600 text-lg">è¼‰å…¥ä¸­...</p>
      </div>
    </div>

    <!-- éŒ¯èª¤è¨Šæ¯ -->
    <div v-if="error" class="fixed inset-0 bg-white flex items-center justify-center z-50">
      <div class="text-center p-8">
        <div class="text-6xl mb-4">ğŸ”’</div>
        <h1 class="text-2xl font-bold text-gray-800 mb-2">ç„¡æ³•é€²å…¥</h1>
        <p class="text-gray-600">{{ error }}</p>
      </div>
    </div>

    <!-- æš±ç¨±è¼¸å…¥ -->
    <div v-if="!loading && !error && !nickname" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50">
      <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md mx-4">
        <h2 class="text-2xl font-bold text-gray-800 mb-2">æ­¡è¿ä½¿ç”¨åœ˜éšŠçœ‹æ¿</h2>
        <p class="text-gray-600 mb-6">è«‹è¼¸å…¥ä½ çš„æš±ç¨±ï¼Œè®“åœ˜éšŠæˆå“¡èªè­˜ä½ </p>
        <input 
          v-model="nicknameInput" 
          @keyup.enter="setNickname"
          type="text" 
          placeholder="è¼¸å…¥æš±ç¨±ï¼ˆä¾‹å¦‚ï¼šå°æ˜ï¼‰" 
          class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none text-lg mb-4"
          maxlength="20"
        >
        <button 
          @click="setNickname" 
          :disabled="!nicknameInput.trim()"
          class="w-full py-3 bg-blue-500 text-white rounded-xl font-medium hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition"
        >
          é–‹å§‹ä½¿ç”¨
        </button>
      </div>
    </div>

    <!-- ä¸»ä»‹é¢ -->
    <div v-if="!loading && !error && nickname" class="min-h-screen flex flex-col">
      
      <!-- é ‚éƒ¨å°è¦½ -->
      <header class="bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between sticky top-0 z-40">
        <div class="flex items-center gap-4">
          <h1 class="text-xl font-bold text-gray-800">ğŸ“‹ åœ˜éšŠçœ‹æ¿</h1>
          
          <!-- çœ‹æ¿é¸æ“‡ -->
          <select 
            v-model="currentBoardId" 
            @change="onBoardChange"
            class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
          >
            <option value="">é¸æ“‡çœ‹æ¿</option>
            <option v-for="board in boards" :key="board.id" :value="board.id">
              {{ board.name }}
            </option>
          </select>
          
          <!-- æ–°å¢çœ‹æ¿æŒ‰éˆ• -->
          <button 
            v-if="role === 'admin'"
            @click="showNewBoardModal = true"
            class="px-3 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition flex items-center gap-1"
          >
            <span>+</span> æ–°å¢çœ‹æ¿
          </button>
        </div>
        
        <div class="flex items-center gap-4">
          <!-- å³æ™‚åŒæ­¥æŒ‡ç¤ºå™¨ -->
          <div class="flex items-center gap-2 text-sm text-gray-500">
            <div class="sync-indicator bg-green-500"></div>
            <span>å³æ™‚åŒæ­¥</span>
          </div>
          
          <!-- è¦–åœ–åˆ‡æ› -->
          <div class="flex bg-gray-100 rounded-lg p-1">
            <button 
              @click="currentView = 'board'"
              :class="currentView === 'board' ? 'bg-white shadow' : ''"
              class="px-4 py-2 rounded-md text-sm font-medium transition"
            >
              çœ‹æ¿
            </button>
            <button 
              @click="currentView = 'calendar'"
              :class="currentView === 'calendar' ? 'bg-white shadow' : ''"
              class="px-4 py-2 rounded-md text-sm font-medium transition"
            >
              æ—¥æ›†
            </button>
            <button 
              @click="currentView = 'gantt'"
              :class="currentView === 'gantt' ? 'bg-white shadow' : ''"
              class="px-4 py-2 rounded-md text-sm font-medium transition"
            >
              ç”˜ç‰¹åœ–
            </button>
          </div>
          
          <!-- ä½¿ç”¨è€…è³‡è¨Š -->
          <div class="flex items-center gap-2 px-3 py-2 bg-gray-100 rounded-lg">
            <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-medium">
              {{ nickname.charAt(0) }}
            </div>
            <span class="text-sm font-medium">{{ nickname }}</span>
            <span class="text-xs px-2 py-1 rounded-full" :class="role === 'admin' ? 'bg-purple-100 text-purple-700' : 'bg-gray-200 text-gray-600'">
              {{ role === 'admin' ? 'ç®¡ç†å“¡' : 'æˆå“¡' }}
            </span>
          </div>
        </div>
      </header>

      <!-- ä¸»è¦å…§å®¹å€ -->
      <main class="flex-1 overflow-hidden">
        
        <!-- çœ‹æ¿è¦–åœ– -->
        <div v-if="currentView === 'board' && currentBoardId" class="h-full p-6 overflow-x-auto">
          <div class="flex gap-4 h-full">
            
            <!-- æ¬„ä½ -->
            <div 
              v-for="column in sortedColumns" 
              :key="column.id"
              :draggable="role === 'admin'"
              @dragstart="onColumnDragStart($event, column)"
              @dragend="onColumnDragEnd"
              @dragover.prevent="onColumnDragOver($event, column)"
              @drop="onColumnDrop($event, column)"
              class="flex-shrink-0 w-80 bg-gray-100 rounded-xl flex flex-col max-h-full"
              :class="{ 'drag-over': dragOverColumn === column.id && draggingColumn }"
            >
              <!-- æ¬„ä½æ¨™é¡Œ -->
              <div class="column-color-bar" :style="{ background: column.color || '#94a3b8' }"></div>
              <div class="p-3 flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <h3 class="font-bold text-gray-800">{{ column.name }}</h3>
                  <span class="text-sm text-gray-500 bg-gray-200 px-2 py-0.5 rounded-full">
                    {{ getCardsInColumn(column.id).length }}
                  </span>
                </div>
                <button 
                  v-if="role === 'admin'"
                  @click="openColumnMenu(column, $event)"
                  class="p-1 hover:bg-gray-200 rounded transition"
                >
                  â‹®
                </button>
              </div>
              
              <!-- å¡ç‰‡åˆ—è¡¨ -->
              <div 
                class="flex-1 overflow-y-auto p-2 space-y-2"
                @dragover.prevent="onCardDragOver($event, column)"
                @drop="onCardDrop($event, column)"
              >
                <div
                  v-for="card in getCardsInColumn(column.id)"
                  :key="card.id"
                  draggable="true"
                  @dragstart="onCardDragStart($event, card)"
                  @dragend="onCardDragEnd"
                  @click="openCardDetail(card)"
                  class="card-item bg-white p-3 rounded-lg shadow-sm cursor-pointer border border-gray-200"
                  :class="{ 'dragging': draggingCard?.id === card.id }"
                >
                  <!-- æ¨™ç±¤ -->
                  <div v-if="card.labels && card.labels.length" class="flex flex-wrap gap-1 mb-2">
                    <span 
                      v-for="label in card.labels" 
                      :key="label"
                      class="text-xs px-2 py-0.5 rounded-full"
                      :class="'label-' + label"
                    >
                      {{ getLabelName(label) }}
                    </span>
                  </div>
                  
                  <!-- æ¨™é¡Œ -->
                  <h4 class="font-medium text-gray-800 mb-2">{{ card.title }}</h4>
                  
                  <!-- åº•éƒ¨è³‡è¨Š -->
                  <div class="flex items-center justify-between text-sm text-gray-500">
                    <div class="flex items-center gap-2">
                      <span v-if="card.dueDate" :class="getDueDateClass(card.dueDate)">
                        ğŸ“… {{ formatDate(card.dueDate) }}
                      </span>
                    </div>
                    <div v-if="card.assignee" class="flex items-center gap-1">
                      <div class="w-6 h-6 bg-gray-300 rounded-full flex items-center justify-center text-xs">
                        {{ card.assignee.charAt(0) }}
                      </div>
                    </div>
                  </div>
                  
                  <!-- æª¢æŸ¥æ¸…å–®é€²åº¦ -->
                  <div v-if="card.checklist && card.checklist.length" class="mt-2">
                    <div class="flex items-center gap-2 text-xs text-gray-500">
                      <div class="flex-1 bg-gray-200 rounded-full h-1.5">
                        <div 
                          class="bg-green-500 h-1.5 rounded-full transition-all"
                          :style="{ width: getChecklistProgress(card.checklist) + '%' }"
                        ></div>
                      </div>
                      <span>{{ getChecklistCompleted(card.checklist) }}/{{ card.checklist.length }}</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- æ–°å¢å¡ç‰‡æŒ‰éˆ• -->
              <div class="p-2">
                <button 
                  @click="openNewCardModal(column)"
                  class="w-full py-2 text-gray-500 hover:bg-gray-200 rounded-lg transition flex items-center justify-center gap-1"
                >
                  <span>+</span> æ–°å¢å¡ç‰‡
                </button>
              </div>
            </div>
            
            <!-- æ–°å¢æ¬„ä½æŒ‰éˆ• -->
            <div v-if="role === 'admin'" class="flex-shrink-0 w-80">
              <button 
                @click="showNewColumnModal = true"
                class="w-full py-4 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 hover:border-blue-400 hover:text-blue-500 transition"
              >
                + æ–°å¢æ¬„ä½
              </button>
            </div>
          </div>
        </div>

        <!-- ç„¡çœ‹æ¿æç¤º -->
        <div v-if="currentView === 'board' && !currentBoardId" class="h-full flex items-center justify-center">
          <div class="text-center">
            <div class="text-6xl mb-4">ğŸ“‹</div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">é–‹å§‹ä½¿ç”¨çœ‹æ¿</h2>
            <p class="text-gray-600 mb-4">é¸æ“‡ç¾æœ‰çœ‹æ¿æˆ–å»ºç«‹æ–°çš„çœ‹æ¿</p>
            <button 
              v-if="role === 'admin'"
              @click="showNewBoardModal = true"
              class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition"
            >
              å»ºç«‹ç¬¬ä¸€å€‹çœ‹æ¿
            </button>
          </div>
        </div>

        <!-- æ—¥æ›†è¦–åœ– -->
        <div v-if="currentView === 'calendar'" class="h-full p-6 overflow-auto">
          <div class="bg-white rounded-xl shadow-sm p-4">
            <!-- æ—¥æ›†æ¨™é¡Œ -->
            <div class="flex items-center justify-between mb-4">
              <button @click="prevMonth" class="p-2 hover:bg-gray-100 rounded-lg">â†</button>
              <h2 class="text-xl font-bold">{{ calendarTitle }}</h2>
              <button @click="nextMonth" class="p-2 hover:bg-gray-100 rounded-lg">â†’</button>
            </div>
            
            <!-- æ˜ŸæœŸæ¨™é¡Œ -->
            <div class="grid grid-cols-7 gap-1 mb-2">
              <div v-for="day in ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­']" :key="day" class="text-center text-sm font-medium text-gray-500 py-2">
                {{ day }}
              </div>
            </div>
            
            <!-- æ—¥æ›†æ ¼å­ -->
            <div class="grid grid-cols-7 gap-1">
              <div 
                v-for="day in calendarDays" 
                :key="day.date"
                class="calendar-day border border-gray-100 rounded-lg p-2"
                :class="{ 
                  'bg-gray-50': !day.isCurrentMonth,
                  'calendar-today': day.isToday
                }"
                @dragover.prevent
                @drop="onCalendarDrop($event, day.date)"
              >
                <div class="text-sm font-medium" :class="day.isCurrentMonth ? 'text-gray-800' : 'text-gray-400'">
                  {{ day.dayNum }}
                </div>
                <div class="mt-1 space-y-1">
                  <div 
                    v-for="card in getCardsOnDate(day.date)" 
                    :key="card.id"
                    @click="openCardDetail(card)"
                    class="text-xs p-1 rounded truncate cursor-pointer hover:opacity-80"
                    :style="{ background: getColumnColor(card.columnId) + '40', color: getColumnColor(card.columnId) }"
                    draggable="true"
                    @dragstart="onCardDragStart($event, card)"
                  >
                    {{ card.title }}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ç”˜ç‰¹åœ–è¦–åœ– -->
        <div v-if="currentView === 'gantt'" class="h-full p-6 overflow-auto">
          <div class="bg-white rounded-xl shadow-sm p-4">
            <h2 class="text-xl font-bold mb-4">ç”˜ç‰¹åœ–</h2>
            
            <!-- ç¯©é¸ -->
            <div class="flex gap-4 mb-4">
              <select v-model="ganttFilter.assignee" class="px-3 py-2 border rounded-lg">
                <option value="">æ‰€æœ‰è² è²¬äºº</option>
                <option v-for="name in allAssignees" :key="name" :value="name">{{ name }}</option>
              </select>
            </div>
            
            <div class="overflow-x-auto">
              <div class="min-w-max">
                <!-- æ—¥æœŸæ¨™é¡Œ -->
                <div class="flex border-b">
                  <div class="w-48 flex-shrink-0 p-2 font-medium">ä»»å‹™</div>
                  <div class="flex">
                    <div 
                      v-for="date in ganttDates" 
                      :key="date"
                      class="w-10 p-1 text-xs text-center border-l"
                      :class="{ 'bg-blue-50': isToday(date) }"
                    >
                      {{ formatGanttDate(date) }}
                    </div>
                  </div>
                </div>
                
                <!-- ä»»å‹™åˆ— -->
                <div 
                  v-for="card in filteredGanttCards" 
                  :key="card.id"
                  class="flex border-b hover:bg-gray-50"
                >
                  <div class="w-48 flex-shrink-0 p-2 truncate">
                    <span class="cursor-pointer hover:text-blue-500" @click="openCardDetail(card)">
                      {{ card.title }}
                    </span>
                  </div>
                  <div class="flex relative flex-1">
                    <div 
                      v-for="date in ganttDates" 
                      :key="date"
                      class="w-10 border-l h-10"
                    ></div>
                    <!-- ç”˜ç‰¹æ¢ -->
                    <div 
                      v-if="card.startDate && card.dueDate"
                      class="gantt-bar absolute top-1 flex items-center justify-center text-xs text-white font-medium"
                      :style="getGanttBarStyle(card)"
                    >
                      {{ card.assignee || '' }}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- ========== å½ˆçª— Modals ========== -->
    
    <!-- æ–°å¢çœ‹æ¿å½ˆçª— -->
    <div v-if="showNewBoardModal" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50" @click.self="showNewBoardModal = false">
      <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md mx-4">
        <h2 class="text-xl font-bold mb-4">æ–°å¢çœ‹æ¿</h2>
        <input 
          v-model="newBoardName" 
          type="text" 
          placeholder="çœ‹æ¿åç¨±" 
          class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none mb-4"
          @keyup.enter="createBoard"
        >
        <div class="flex gap-2">
          <button @click="showNewBoardModal = false" class="flex-1 py-3 border border-gray-300 rounded-xl hover:bg-gray-50 transition">å–æ¶ˆ</button>
          <button @click="createBoard" :disabled="!newBoardName.trim()" class="flex-1 py-3 bg-blue-500 text-white rounded-xl hover:bg-blue-600 disabled:bg-gray-300 transition">å»ºç«‹</button>
        </div>
      </div>
    </div>

    <!-- æ–°å¢æ¬„ä½å½ˆçª— -->
    <div v-if="showNewColumnModal" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50" @click.self="showNewColumnModal = false">
      <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md mx-4">
        <h2 class="text-xl font-bold mb-4">æ–°å¢æ¬„ä½</h2>
        <input 
          v-model="newColumnName" 
          type="text" 
          placeholder="æ¬„ä½åç¨±ï¼ˆä¾‹å¦‚ï¼šå¾…è¾¦äº‹é …ï¼‰" 
          class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none mb-4"
        >
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">æ¬„ä½é¡è‰²</label>
          <div class="flex gap-2">
            <button 
              v-for="color in columnColors" 
              :key="color"
              @click="newColumnColor = color"
              class="w-8 h-8 rounded-full transition ring-offset-2"
              :class="{ 'ring-2 ring-gray-400': newColumnColor === color }"
              :style="{ background: color }"
            ></button>
          </div>
        </div>
        <div class="flex gap-2">
          <button @click="showNewColumnModal = false" class="flex-1 py-3 border border-gray-300 rounded-xl hover:bg-gray-50 transition">å–æ¶ˆ</button>
          <button @click="createColumn" :disabled="!newColumnName.trim()" class="flex-1 py-3 bg-blue-500 text-white rounded-xl hover:bg-blue-600 disabled:bg-gray-300 transition">å»ºç«‹</button>
        </div>
      </div>
    </div>

    <!-- æ–°å¢å¡ç‰‡å½ˆçª— -->
    <div v-if="showNewCardModal" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50" @click.self="showNewCardModal = false">
      <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md mx-4">
        <h2 class="text-xl font-bold mb-4">æ–°å¢å¡ç‰‡</h2>
        <input 
          v-model="newCardTitle" 
          type="text" 
          placeholder="å¡ç‰‡æ¨™é¡Œ" 
          class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none mb-4"
          @keyup.enter="createCard"
        >
        <div class="flex gap-2">
          <button @click="showNewCardModal = false" class="flex-1 py-3 border border-gray-300 rounded-xl hover:bg-gray-50 transition">å–æ¶ˆ</button>
          <button @click="createCard" :disabled="!newCardTitle.trim()" class="flex-1 py-3 bg-blue-500 text-white rounded-xl hover:bg-blue-600 disabled:bg-gray-300 transition">å»ºç«‹</button>
        </div>
      </div>
    </div>

    <!-- å¡ç‰‡è©³æƒ…å½ˆçª— -->
    <div v-if="showCardDetail && editingCard" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 p-4" @click.self="closeCardDetail">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="p-6">
          <!-- æ¨™é¡Œ -->
          <div class="flex items-start justify-between mb-4">
            <input 
              v-model="editingCard.title" 
              class="text-2xl font-bold text-gray-800 w-full border-0 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded px-2 py-1 -ml-2"
              placeholder="å¡ç‰‡æ¨™é¡Œ"
            >
            <button @click="closeCardDetail" class="p-2 hover:bg-gray-100 rounded-lg ml-2">âœ•</button>
          </div>
          
          <div class="grid grid-cols-3 gap-6">
            <!-- å·¦å´ä¸»è¦å…§å®¹ -->
            <div class="col-span-2 space-y-6">
              <!-- æè¿° -->
              <div>
                <h3 class="font-medium text-gray-700 mb-2">æè¿°</h3>
                <textarea 
                  v-model="editingCard.description" 
                  class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none resize-none"
                  rows="4"
                  placeholder="æ–°å¢æè¿°..."
                ></textarea>
              </div>
              
              <!-- æª¢æŸ¥æ¸…å–® -->
              <div>
                <h3 class="font-medium text-gray-700 mb-2">æª¢æŸ¥æ¸…å–®</h3>
                <div class="space-y-2">
                  <div 
                    v-for="(item, index) in editingCard.checklist" 
                    :key="index"
                    class="flex items-center gap-2"
                  >
                    <input 
                      type="checkbox" 
                      v-model="item.done"
                      class="w-5 h-5 rounded border-gray-300 text-blue-500 focus:ring-blue-500"
                    >
                    <input 
                      v-model="item.text" 
                      class="flex-1 px-2 py-1 border-0 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded"
                      :class="{ 'line-through text-gray-400': item.done }"
                    >
                    <button @click="removeChecklistItem(index)" class="p-1 hover:bg-red-100 text-red-500 rounded">âœ•</button>
                  </div>
                </div>
                <button 
                  @click="addChecklistItem" 
                  class="mt-2 text-sm text-blue-500 hover:text-blue-600"
                >
                  + æ–°å¢é …ç›®
                </button>
              </div>
              
              <!-- ç•™è¨€ -->
              <div>
                <h3 class="font-medium text-gray-700 mb-2">ç•™è¨€</h3>
                <div class="flex gap-2 mb-4">
                  <input 
                    v-model="newComment" 
                    type="text" 
                    placeholder="å¯«å€‹ç•™è¨€..." 
                    class="flex-1 px-4 py-2 border border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none"
                    @keyup.enter="addComment"
                  >
                  <button 
                    @click="addComment" 
                    :disabled="!newComment.trim()"
                    class="px-4 py-2 bg-blue-500 text-white rounded-xl hover:bg-blue-600 disabled:bg-gray-300 transition"
                  >
                    é€å‡º
                  </button>
                </div>
                <div class="space-y-3">
                  <div v-for="comment in cardComments" :key="comment.id" class="flex gap-3">
                    <div class="w-8 h-8 bg-gray-300 rounded-full flex-shrink-0 flex items-center justify-center text-sm font-medium">
                      {{ comment.author?.charAt(0) || '?' }}
                    </div>
                    <div class="flex-1">
                      <div class="flex items-center gap-2">
                        <span class="font-medium text-gray-800">{{ comment.author }}</span>
                        <span class="text-xs text-gray-400">{{ formatDateTime(comment.createdAt) }}</span>
                      </div>
                      <p class="text-gray-600">{{ comment.content }}</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- å³å´å±¬æ€§ -->
            <div class="space-y-4">
              <!-- è² è²¬äºº -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">è² è²¬äºº</label>
                <input 
                  v-model="editingCard.assignee" 
                  type="text" 
                  placeholder="è¼¸å…¥åå­—"
                  class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"
                >
              </div>
              
              <!-- é–‹å§‹æ—¥æœŸ -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">é–‹å§‹æ—¥æœŸ</label>
                <input 
                  v-model="editingCard.startDate" 
                  type="date" 
                  class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"
                >
              </div>
              
              <!-- æˆªæ­¢æ—¥æœŸ -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">æˆªæ­¢æ—¥æœŸ</label>
                <input 
                  v-model="editingCard.dueDate" 
                  type="date" 
                  class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"
                >
              </div>
              
              <!-- æ¨™ç±¤ -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">æ¨™ç±¤</label>
                <div class="flex flex-wrap gap-2">
                  <button 
                    v-for="(name, key) in labelNames" 
                    :key="key"
                    @click="toggleLabel(key)"
                    class="px-3 py-1 rounded-full text-sm transition"
                    :class="[
                      'label-' + key,
                      editingCard.labels?.includes(key) ? 'ring-2 ring-offset-1 ring-gray-400' : 'opacity-60 hover:opacity-100'
                    ]"
                  >
                    {{ name }}
                  </button>
                </div>
              </div>
              
              <!-- ç§»å‹•åˆ°å…¶ä»–æ¬„ä½ -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ç§»å‹•åˆ°</label>
                <select 
                  v-model="editingCard.columnId"
                  class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"
                >
                  <option v-for="col in columns" :key="col.id" :value="col.id">{{ col.name }}</option>
                </select>
              </div>
              
              <!-- åˆªé™¤æŒ‰éˆ• -->
              <button 
                @click="deleteCard"
                class="w-full py-2 border border-red-300 text-red-500 rounded-lg hover:bg-red-50 transition mt-4"
              >
                åˆªé™¤å¡ç‰‡
              </button>
            </div>
          </div>
        </div>
        
        <!-- åº•éƒ¨å„²å­˜ -->
        <div class="border-t p-4 flex justify-end gap-2 bg-gray-50 rounded-b-2xl">
          <button @click="closeCardDetail" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition">å–æ¶ˆ</button>
          <button @click="saveCard" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">å„²å­˜</button>
        </div>
      </div>
    </div>

    <!-- æ¬„ä½é¸å–® -->
    <div 
      v-if="showColumnMenu && selectedColumn" 
      class="fixed bg-white rounded-lg shadow-xl border z-50 py-2 w-48"
      :style="{ top: columnMenuPosition.y + 'px', left: columnMenuPosition.x + 'px' }"
    >
      <button @click="startEditColumn" class="w-full px-4 py-2 text-left hover:bg-gray-100">ç·¨è¼¯æ¬„ä½</button>
      <button @click="confirmArchiveColumn" class="w-full px-4 py-2 text-left hover:bg-gray-100 text-red-500">åˆªé™¤æ¬„ä½</button>
    </div>
    
    <!-- æ¬„ä½é¸å–®èƒŒæ™¯ -->
    <div v-if="showColumnMenu" class="fixed inset-0 z-40" @click="showColumnMenu = false"></div>

    <!-- ç·¨è¼¯æ¬„ä½å½ˆçª— -->
    <div v-if="showEditColumnModal && editingColumn" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50" @click.self="showEditColumnModal = false">
      <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md mx-4">
        <h2 class="text-xl font-bold mb-4">ç·¨è¼¯æ¬„ä½</h2>
        <input 
          v-model="editingColumn.name" 
          type="text" 
          placeholder="æ¬„ä½åç¨±" 
          class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none mb-4"
        >
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">æ¬„ä½é¡è‰²</label>
          <div class="flex gap-2">
            <button 
              v-for="color in columnColors" 
              :key="color"
              @click="editingColumn.color = color"
              class="w-8 h-8 rounded-full transition ring-offset-2"
              :class="{ 'ring-2 ring-gray-400': editingColumn.color === color }"
              :style="{ background: color }"
            ></button>
          </div>
        </div>
        <div class="flex gap-2">
          <button @click="showEditColumnModal = false" class="flex-1 py-3 border border-gray-300 rounded-xl hover:bg-gray-50 transition">å–æ¶ˆ</button>
          <button @click="saveColumn" class="flex-1 py-3 bg-blue-500 text-white rounded-xl hover:bg-blue-600 transition">å„²å­˜</button>
        </div>
      </div>
    </div>

    <!-- ç¢ºèªåˆªé™¤æ¬„ä½å½ˆçª— -->
    <div v-if="showArchiveConfirm && archivingColumn" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50" @click.self="showArchiveConfirm = false">
      <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md mx-4">
        <h2 class="text-xl font-bold mb-2">ç¢ºèªåˆªé™¤</h2>
        <p class="text-gray-600 mb-4">ç¢ºå®šè¦åˆªé™¤ã€Œ{{ archivingColumn.name }}ã€æ¬„ä½å—ï¼Ÿæ¬„ä½å…§çš„æ‰€æœ‰å¡ç‰‡ä¹Ÿæœƒè¢«åˆªé™¤ã€‚</p>
        <div class="flex gap-2">
          <button @click="showArchiveConfirm = false" class="flex-1 py-3 border border-gray-300 rounded-xl hover:bg-gray-50 transition">å–æ¶ˆ</button>
          <button @click="archiveColumn" class="flex-1 py-3 bg-red-500 text-white rounded-xl hover:bg-red-600 transition">åˆªé™¤</button>
        </div>
      </div>
    </div>

    <!-- Toast é€šçŸ¥ -->
    <div 
      v-if="toast.show" 
      class="fixed bottom-4 right-4 px-6 py-3 rounded-xl shadow-lg z-50 transition-all"
      :class="{
        'bg-green-500 text-white': toast.type === 'success',
        'bg-red-500 text-white': toast.type === 'error',
        'bg-blue-500 text-white': toast.type === 'info'
      }"
    >
      {{ toast.message }}
    </div>

  </div>

  <script>
    const { createApp, ref, computed, onMounted, onUnmounted, watch } = Vue;

    // Firebase è¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyD-j2mxePfU6qj4qMXR_-u-VXuzpv-zEkg",
      authDomain: "team-kanban-f58ae.firebaseapp.com",
      projectId: "team-kanban-f58ae",
      storageBucket: "team-kanban-f58ae.firebasestorage.app",
      messagingSenderId: "15717920457",
      appId: "1:15717920457:web:42b4491eea9486f9e42718"
    };

    // åˆå§‹åŒ– Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    createApp({
      setup() {
        // ===== åŸºæœ¬ç‹€æ…‹ =====
        const loading = ref(true);
        const error = ref('');
        const token = ref('');
        const role = ref('member');
        const nickname = ref('');
        const nicknameInput = ref('');

        // ===== è³‡æ–™ç‹€æ…‹ =====
        const boards = ref([]);
        const currentBoardId = ref('');
        const columns = ref([]);
        const cards = ref([]);
        const cardComments = ref([]);

        // ===== UI ç‹€æ…‹ =====
        const currentView = ref('board');
        const showNewBoardModal = ref(false);
        const showNewColumnModal = ref(false);
        const showNewCardModal = ref(false);
        const showCardDetail = ref(false);
        const showColumnMenu = ref(false);
        const showEditColumnModal = ref(false);
        const showArchiveConfirm = ref(false);

        // ===== ç·¨è¼¯ç‹€æ…‹ =====
        const editingCard = ref(null);
        const editingColumn = ref(null);
        const selectedColumn = ref(null);
        const archivingColumn = ref(null);
        const selectedColumnForNewCard = ref(null);

        // ===== è¼¸å…¥ç‹€æ…‹ =====
        const newBoardName = ref('');
        const newColumnName = ref('');
        const newColumnColor = ref('#3b82f6');
        const newCardTitle = ref('');
        const newComment = ref('');

        // ===== æ‹–æ‹‰ç‹€æ…‹ =====
        const draggingCard = ref(null);
        const draggingColumn = ref(null);
        const dragOverColumn = ref(null);

        // ===== æ—¥æ›†ç‹€æ…‹ =====
        const calendarDate = ref(new Date());

        // ===== ç”˜ç‰¹åœ–ç‹€æ…‹ =====
        const ganttFilter = ref({ assignee: '' });

        // ===== Toast =====
        const toast = ref({ show: false, message: '', type: 'info' });
        const columnMenuPosition = ref({ x: 0, y: 0 });

        // ===== å¸¸æ•¸ =====
        const columnColors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#6b7280'];
        const labelNames = {
          red: 'ç·Šæ€¥',
          orange: 'é‡è¦', 
          yellow: 'å¾…ç¢ºèª',
          green: 'é€²è¡Œä¸­',
          blue: 'è³‡è¨Š',
          purple: 'æƒ³æ³•'
        };

        // ===== Firestore å³æ™‚ç›£è½ =====
        let unsubscribeBoards = null;
        let unsubscribeColumns = null;
        let unsubscribeCards = null;

        // ===== è¨ˆç®—å±¬æ€§ =====
        const sortedColumns = computed(() => {
          return [...columns.value].sort((a, b) => (a.orderIndex || 0) - (b.orderIndex || 0));
        });

        const calendarTitle = computed(() => {
          const year = calendarDate.value.getFullYear();
          const month = calendarDate.value.getMonth() + 1;
          return `${year} å¹´ ${month} æœˆ`;
        });

        const calendarDays = computed(() => {
          const year = calendarDate.value.getFullYear();
          const month = calendarDate.value.getMonth();
          const firstDay = new Date(year, month, 1);
          const lastDay = new Date(year, month + 1, 0);
          const startDate = new Date(firstDay);
          startDate.setDate(startDate.getDate() - startDate.getDay());
          
          const days = [];
          const today = new Date().toISOString().split('T')[0];
          
          for (let i = 0; i < 42; i++) {
            const date = new Date(startDate);
            date.setDate(date.getDate() + i);
            const dateStr = date.toISOString().split('T')[0];
            days.push({
              date: dateStr,
              dayNum: date.getDate(),
              isCurrentMonth: date.getMonth() === month,
              isToday: dateStr === today
            });
          }
          return days;
        });

        const ganttDates = computed(() => {
          const dates = [];
          const start = new Date();
          start.setDate(start.getDate() - 7);
          for (let i = 0; i < 30; i++) {
            const d = new Date(start);
            d.setDate(d.getDate() + i);
            dates.push(d.toISOString().split('T')[0]);
          }
          return dates;
        });

        const allAssignees = computed(() => {
          const assignees = new Set();
          cards.value.forEach(c => {
            if (c.assignee) assignees.add(c.assignee);
          });
          return Array.from(assignees);
        });

        const filteredGanttCards = computed(() => {
          return cards.value.filter(c => {
            if (!c.startDate && !c.dueDate) return false;
            if (ganttFilter.value.assignee && c.assignee !== ganttFilter.value.assignee) return false;
            return true;
          });
        });

        // ===== å·¥å…·å‡½å¼ =====
        const showToast = (message, type = 'info') => {
          toast.value = { show: true, message, type };
          setTimeout(() => { toast.value.show = false; }, 3000);
        };

        const generateId = () => {
          return Date.now().toString(36) + Math.random().toString(36).substr(2);
        };

        const formatDate = (dateStr) => {
          if (!dateStr) return '';
          const date = new Date(dateStr);
          return `${date.getMonth() + 1}/${date.getDate()}`;
        };

        const formatDateTime = (timestamp) => {
          if (!timestamp) return '';
          const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
          return `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
        };

        const formatGanttDate = (dateStr) => {
          const date = new Date(dateStr);
          return `${date.getMonth() + 1}/${date.getDate()}`;
        };

        const isToday = (dateStr) => {
          return dateStr === new Date().toISOString().split('T')[0];
        };

        const getDueDateClass = (dueDate) => {
          if (!dueDate) return '';
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const due = new Date(dueDate);
          const diff = (due - today) / (1000 * 60 * 60 * 24);
          if (diff < 0) return 'text-red-500 font-medium';
          if (diff <= 2) return 'text-orange-500 font-medium';
          return 'text-gray-500';
        };

        const getLabelName = (key) => labelNames[key] || key;

        const getColumnColor = (columnId) => {
          const col = columns.value.find(c => c.id === columnId);
          return col?.color || '#94a3b8';
        };

        const getCardsInColumn = (columnId) => {
          return cards.value
            .filter(c => c.columnId === columnId)
            .sort((a, b) => (a.orderIndex || 0) - (b.orderIndex || 0));
        };

        const getCardsOnDate = (dateStr) => {
          return cards.value.filter(c => c.dueDate === dateStr);
        };

        const getChecklistProgress = (checklist) => {
          if (!checklist || !checklist.length) return 0;
          const done = checklist.filter(i => i.done).length;
          return Math.round((done / checklist.length) * 100);
        };

        const getChecklistCompleted = (checklist) => {
          if (!checklist) return 0;
          return checklist.filter(i => i.done).length;
        };

        const getGanttBarStyle = (card) => {
          const startIdx = ganttDates.value.indexOf(card.startDate);
          const endIdx = ganttDates.value.indexOf(card.dueDate);
          if (startIdx === -1 || endIdx === -1) return { display: 'none' };
          
          const left = startIdx * 40;
          const width = (endIdx - startIdx + 1) * 40 - 4;
          const color = getColumnColor(card.columnId);
          
          return {
            left: left + 'px',
            width: Math.max(width, 40) + 'px',
            background: color
          };
        };

        // ===== åˆå§‹åŒ– =====
        const initialize = async () => {
          // å¾ URL å–å¾— token
          const urlParams = new URLSearchParams(window.location.search);
          token.value = urlParams.get('token') || '';

          if (!token.value) {
            error.value = 'è«‹ä½¿ç”¨æœ‰æ•ˆçš„é€£çµé€²å…¥ç³»çµ±';
            loading.value = false;
            return;
          }

          // å¾ localStorage è®€å–æš±ç¨±
          const savedNickname = localStorage.getItem('kanban_nickname');
          if (savedNickname) {
            nickname.value = savedNickname;
          }

          // é©—è­‰ token ä¸¦å–å¾—è§’è‰²
          try {
            const configDoc = await db.collection('config').doc('tokens').get();
            
            if (!configDoc.exists) {
              // ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Œå»ºç«‹åˆå§‹è¨­å®š
              const adminToken = generateId();
              const memberToken = generateId();
              
              await db.collection('config').doc('tokens').set({
                adminToken: adminToken,
                memberToken: memberToken,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
              });

              console.log('=== ç³»çµ±åˆå§‹åŒ–å®Œæˆ ===');
              console.log('Admin Token:', adminToken);
              console.log('Member Token:', memberToken);
              console.log('Admin é€£çµ:', window.location.origin + window.location.pathname + '?token=' + adminToken);
              console.log('Member é€£çµ:', window.location.origin + window.location.pathname + '?token=' + memberToken);
              
              error.value = 'ç³»çµ±å·²åˆå§‹åŒ–ï¼Œè«‹æŸ¥çœ‹ç€è¦½å™¨ Console (F12) å–å¾—é€£çµ';
              loading.value = false;
              return;
            }

            const config = configDoc.data();
            
            if (token.value === config.adminToken) {
              role.value = 'admin';
            } else if (token.value === config.memberToken) {
              role.value = 'member';
            } else {
              error.value = 'ç„¡æ•ˆçš„é€£çµï¼Œè«‹ç¢ºèªé€£çµæ˜¯å¦æ­£ç¢º';
              loading.value = false;
              return;
            }

            // é–‹å§‹ç›£è½è³‡æ–™
            startListening();
            
          } catch (err) {
            console.error('åˆå§‹åŒ–éŒ¯èª¤:', err);
            error.value = 'ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦';
          }
          
          loading.value = false;
        };

        // ===== å³æ™‚ç›£è½ =====
        const startListening = () => {
          // ç›£è½çœ‹æ¿
          unsubscribeBoards = db.collection('boards')
            .orderBy('createdAt', 'asc')
            .onSnapshot(snapshot => {
              boards.value = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
              }));
              
              // å¦‚æœæ²’æœ‰é¸æ“‡çœ‹æ¿ï¼Œé¸ç¬¬ä¸€å€‹
              if (!currentBoardId.value && boards.value.length > 0) {
                currentBoardId.value = boards.value[0].id;
              }
            });
        };

        const startBoardListening = (boardId) => {
          // å–æ¶ˆä¹‹å‰çš„ç›£è½
          if (unsubscribeColumns) unsubscribeColumns();
          if (unsubscribeCards) unsubscribeCards();

          // ç›£è½æ¬„ä½
          unsubscribeColumns = db.collection('columns')
            .where('boardId', '==', boardId)
            .onSnapshot(snapshot => {
              columns.value = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
              }));
            });

          // ç›£è½å¡ç‰‡
          unsubscribeCards = db.collection('cards')
            .where('boardId', '==', boardId)
            .onSnapshot(snapshot => {
              cards.value = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
              }));
            });
        };

        // ç›£è½ currentBoardId è®ŠåŒ–
        watch(currentBoardId, (newId) => {
          if (newId) {
            startBoardListening(newId);
          }
        });

        // ===== æš±ç¨± =====
        const setNickname = () => {
          if (nicknameInput.value.trim()) {
            nickname.value = nicknameInput.value.trim();
            localStorage.setItem('kanban_nickname', nickname.value);
          }
        };

        // ===== çœ‹æ¿æ“ä½œ =====
        const onBoardChange = () => {
          // åˆ‡æ›çœ‹æ¿æ™‚æ¸…ç©ºè³‡æ–™
          columns.value = [];
          cards.value = [];
        };

        const createBoard = async () => {
          if (!newBoardName.value.trim()) return;
          
          try {
            const docRef = await db.collection('boards').add({
              name: newBoardName.value.trim(),
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              createdBy: nickname.value
            });
            
            currentBoardId.value = docRef.id;
            newBoardName.value = '';
            showNewBoardModal.value = false;
            showToast('çœ‹æ¿å·²å»ºç«‹', 'success');
          } catch (err) {
            console.error('å»ºç«‹çœ‹æ¿éŒ¯èª¤:', err);
            showToast('å»ºç«‹å¤±æ•—', 'error');
          }
        };

        // ===== æ¬„ä½æ“ä½œ =====
        const createColumn = async () => {
          if (!newColumnName.value.trim() || !currentBoardId.value) return;
          
          try {
            const maxOrder = columns.value.reduce((max, c) => Math.max(max, c.orderIndex || 0), 0);
            
            await db.collection('columns').add({
              boardId: currentBoardId.value,
              name: newColumnName.value.trim(),
              color: newColumnColor.value,
              orderIndex: maxOrder + 1,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            newColumnName.value = '';
            newColumnColor.value = '#3b82f6';
            showNewColumnModal.value = false;
            showToast('æ¬„ä½å·²å»ºç«‹', 'success');
          } catch (err) {
            console.error('å»ºç«‹æ¬„ä½éŒ¯èª¤:', err);
            showToast('å»ºç«‹å¤±æ•—', 'error');
          }
        };

        const openColumnMenu = (column, event) => {
          selectedColumn.value = column;
          columnMenuPosition.value = { x: event.clientX, y: event.clientY };
          showColumnMenu.value = true;
        };

        const startEditColumn = () => {
          editingColumn.value = { ...selectedColumn.value };
          showColumnMenu.value = false;
          showEditColumnModal.value = true;
        };

        const saveColumn = async () => {
          if (!editingColumn.value) return;
          
          try {
            await db.collection('columns').doc(editingColumn.value.id).update({
              name: editingColumn.value.name,
              color: editingColumn.value.color,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            showEditColumnModal.value = false;
            showToast('æ¬„ä½å·²æ›´æ–°', 'success');
          } catch (err) {
            console.error('æ›´æ–°æ¬„ä½éŒ¯èª¤:', err);
            showToast('æ›´æ–°å¤±æ•—', 'error');
          }
        };

        const confirmArchiveColumn = () => {
          archivingColumn.value = selectedColumn.value;
          showColumnMenu.value = false;
          showArchiveConfirm.value = true;
        };

        const archiveColumn = async () => {
          if (!archivingColumn.value) return;
          
          try {
            // åˆªé™¤æ¬„ä½å…§çš„æ‰€æœ‰å¡ç‰‡
            const cardsInColumn = cards.value.filter(c => c.columnId === archivingColumn.value.id);
            const batch = db.batch();
            
            cardsInColumn.forEach(card => {
              batch.delete(db.collection('cards').doc(card.id));
            });
            
            batch.delete(db.collection('columns').doc(archivingColumn.value.id));
            
            await batch.commit();
            
            showArchiveConfirm.value = false;
            archivingColumn.value = null;
            showToast('æ¬„ä½å·²åˆªé™¤', 'success');
          } catch (err) {
            console.error('åˆªé™¤æ¬„ä½éŒ¯èª¤:', err);
            showToast('åˆªé™¤å¤±æ•—', 'error');
          }
        };

        // ===== å¡ç‰‡æ“ä½œ =====
        const openNewCardModal = (column) => {
          selectedColumnForNewCard.value = column;
          newCardTitle.value = '';
          showNewCardModal.value = true;
        };

        const createCard = async () => {
          if (!newCardTitle.value.trim() || !selectedColumnForNewCard.value) return;
          
          try {
            const cardsInColumn = getCardsInColumn(selectedColumnForNewCard.value.id);
            const maxOrder = cardsInColumn.reduce((max, c) => Math.max(max, c.orderIndex || 0), 0);
            
            await db.collection('cards').add({
              boardId: currentBoardId.value,
              columnId: selectedColumnForNewCard.value.id,
              title: newCardTitle.value.trim(),
              description: '',
              assignee: '',
              startDate: '',
              dueDate: '',
              labels: [],
              checklist: [],
              orderIndex: maxOrder + 1,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              createdBy: nickname.value
            });
            
            newCardTitle.value = '';
            showNewCardModal.value = false;
            showToast('å¡ç‰‡å·²å»ºç«‹', 'success');
          } catch (err) {
            console.error('å»ºç«‹å¡ç‰‡éŒ¯èª¤:', err);
            showToast('å»ºç«‹å¤±æ•—', 'error');
          }
        };

        const openCardDetail = async (card) => {
          editingCard.value = { 
            ...card,
            labels: card.labels || [],
            checklist: card.checklist || []
          };
          showCardDetail.value = true;
          
          // è¼‰å…¥ç•™è¨€
          try {
            const snapshot = await db.collection('comments')
              .where('cardId', '==', card.id)
              .orderBy('createdAt', 'desc')
              .get();
            
            cardComments.value = snapshot.docs.map(doc => ({
              id: doc.id,
              ...doc.data()
            }));
          } catch (err) {
            console.error('è¼‰å…¥ç•™è¨€éŒ¯èª¤:', err);
            cardComments.value = [];
          }
        };

        const closeCardDetail = () => {
          showCardDetail.value = false;
          editingCard.value = null;
          cardComments.value = [];
          newComment.value = '';
        };

        const saveCard = async () => {
          if (!editingCard.value) return;
          
          try {
            const { id, ...data } = editingCard.value;
            await db.collection('cards').doc(id).update({
              ...data,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
              updatedBy: nickname.value
            });
            
            closeCardDetail();
            showToast('å¡ç‰‡å·²å„²å­˜', 'success');
          } catch (err) {
            console.error('å„²å­˜å¡ç‰‡éŒ¯èª¤:', err);
            showToast('å„²å­˜å¤±æ•—', 'error');
          }
        };

        const deleteCard = async () => {
          if (!editingCard.value) return;
          
          if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å¼µå¡ç‰‡å—ï¼Ÿ')) return;
          
          try {
            await db.collection('cards').doc(editingCard.value.id).delete();
            closeCardDetail();
            showToast('å¡ç‰‡å·²åˆªé™¤', 'success');
          } catch (err) {
            console.error('åˆªé™¤å¡ç‰‡éŒ¯èª¤:', err);
            showToast('åˆªé™¤å¤±æ•—', 'error');
          }
        };

        const toggleLabel = (label) => {
          if (!editingCard.value.labels) {
            editingCard.value.labels = [];
          }
          const idx = editingCard.value.labels.indexOf(label);
          if (idx === -1) {
            editingCard.value.labels.push(label);
          } else {
            editingCard.value.labels.splice(idx, 1);
          }
        };

        const addChecklistItem = () => {
          if (!editingCard.value.checklist) {
            editingCard.value.checklist = [];
          }
          editingCard.value.checklist.push({ text: '', done: false });
        };

        const removeChecklistItem = (index) => {
          editingCard.value.checklist.splice(index, 1);
        };

        const addComment = async () => {
          if (!newComment.value.trim() || !editingCard.value) return;
          
          try {
            await db.collection('comments').add({
              cardId: editingCard.value.id,
              author: nickname.value,
              content: newComment.value.trim(),
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // é‡æ–°è¼‰å…¥ç•™è¨€
            const snapshot = await db.collection('comments')
              .where('cardId', '==', editingCard.value.id)
              .orderBy('createdAt', 'desc')
              .get();
            
            cardComments.value = snapshot.docs.map(doc => ({
              id: doc.id,
              ...doc.data()
            }));
            
            newComment.value = '';
            showToast('ç•™è¨€å·²é€å‡º', 'success');
          } catch (err) {
            console.error('é€å‡ºç•™è¨€éŒ¯èª¤:', err);
            showToast('é€å‡ºå¤±æ•—', 'error');
          }
        };

        // ===== æ‹–æ‹‰æ“ä½œ =====
        const onCardDragStart = (event, card) => {
          draggingCard.value = card;
          event.dataTransfer.effectAllowed = 'move';
        };

        const onCardDragEnd = () => {
          draggingCard.value = null;
        };

        const onCardDragOver = (event, column) => {
          if (draggingCard.value) {
            dragOverColumn.value = column.id;
          }
        };

        const onCardDrop = async (event, column) => {
          dragOverColumn.value = null;
          
          if (!draggingCard.value) return;
          if (draggingCard.value.columnId === column.id) return;
          
          try {
            const cardsInColumn = getCardsInColumn(column.id);
            const maxOrder = cardsInColumn.reduce((max, c) => Math.max(max, c.orderIndex || 0), 0);
            
            await db.collection('cards').doc(draggingCard.value.id).update({
              columnId: column.id,
              orderIndex: maxOrder + 1,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
              updatedBy: nickname.value
            });
            
            showToast('å¡ç‰‡å·²ç§»å‹•', 'success');
          } catch (err) {
            console.error('ç§»å‹•å¡ç‰‡éŒ¯èª¤:', err);
            showToast('ç§»å‹•å¤±æ•—', 'error');
          }
          
          draggingCard.value = null;
        };

        const onColumnDragStart = (event, column) => {
          if (role.value !== 'admin') return;
          draggingColumn.value = column;
          event.dataTransfer.effectAllowed = 'move';
        };

        const onColumnDragEnd = () => {
          draggingColumn.value = null;
          dragOverColumn.value = null;
        };

        const onColumnDragOver = (event, column) => {
          if (draggingColumn.value && draggingColumn.value.id !== column.id) {
            dragOverColumn.value = column.id;
          }
        };

        const onColumnDrop = async (event, targetColumn) => {
          if (!draggingColumn.value || draggingColumn.value.id === targetColumn.id) {
            dragOverColumn.value = null;
            return;
          }
          
          try {
            const sorted = sortedColumns.value;
            const fromIdx = sorted.findIndex(c => c.id === draggingColumn.value.id);
            const toIdx = sorted.findIndex(c => c.id === targetColumn.id);
            
            // é‡æ–°è¨ˆç®—é †åº
            const batch = db.batch();
            const reordered = [...sorted];
            const [moved] = reordered.splice(fromIdx, 1);
            reordered.splice(toIdx, 0, moved);
            
            reordered.forEach((col, idx) => {
              batch.update(db.collection('columns').doc(col.id), { orderIndex: idx });
            });
            
            await batch.commit();
            showToast('æ¬„ä½é †åºå·²æ›´æ–°', 'success');
          } catch (err) {
            console.error('æ›´æ–°é †åºéŒ¯èª¤:', err);
            showToast('æ›´æ–°å¤±æ•—', 'error');
          }
          
          draggingColumn.value = null;
          dragOverColumn.value = null;
        };

        // ===== æ—¥æ›†æ“ä½œ =====
        const prevMonth = () => {
          const d = new Date(calendarDate.value);
          d.setMonth(d.getMonth() - 1);
          calendarDate.value = d;
        };

        const nextMonth = () => {
          const d = new Date(calendarDate.value);
          d.setMonth(d.getMonth() + 1);
          calendarDate.value = d;
        };

        const onCalendarDrop = async (event, dateStr) => {
          if (!draggingCard.value) return;
          
          try {
            await db.collection('cards').doc(draggingCard.value.id).update({
              dueDate: dateStr,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
              updatedBy: nickname.value
            });
            
            showToast('æˆªæ­¢æ—¥æœŸå·²æ›´æ–°', 'success');
          } catch (err) {
            console.error('æ›´æ–°æ—¥æœŸéŒ¯èª¤:', err);
            showToast('æ›´æ–°å¤±æ•—', 'error');
          }
          
          draggingCard.value = null;
        };

        // ===== ç”Ÿå‘½é€±æœŸ =====
        onMounted(() => {
          initialize();
        });

        onUnmounted(() => {
          if (unsubscribeBoards) unsubscribeBoards();
          if (unsubscribeColumns) unsubscribeColumns();
          if (unsubscribeCards) unsubscribeCards();
        });

        // ===== è¿”å› =====
        return {
          // ç‹€æ…‹
          loading,
          error,
          token,
          role,
          nickname,
          nicknameInput,
          boards,
          currentBoardId,
          columns,
          cards,
          cardComments,
          currentView,
          showNewBoardModal,
          showNewColumnModal,
          showNewCardModal,
          showCardDetail,
          showColumnMenu,
          showEditColumnModal,
          showArchiveConfirm,
          editingCard,
          editingColumn,
          selectedColumn,
          archivingColumn,
          newBoardName,
          newColumnName,
          newColumnColor,
          newCardTitle,
          newComment,
          draggingCard,
          draggingColumn,
          dragOverColumn,
          calendarDate,
          ganttFilter,
          toast,
          columnMenuPosition,
          columnColors,
          labelNames,
          
          // è¨ˆç®—å±¬æ€§
          sortedColumns,
          calendarTitle,
          calendarDays,
          ganttDates,
          allAssignees,
          filteredGanttCards,
          
          // æ–¹æ³•
          setNickname,
          onBoardChange,
          createBoard,
          createColumn,
          openColumnMenu,
          startEditColumn,
          saveColumn,
          confirmArchiveColumn,
          archiveColumn,
          openNewCardModal,
          createCard,
          openCardDetail,
          closeCardDetail,
          saveCard,
          deleteCard,
          toggleLabel,
          addChecklistItem,
          removeChecklistItem,
          addComment,
          onCardDragStart,
          onCardDragEnd,
          onCardDragOver,
          onCardDrop,
          onColumnDragStart,
          onColumnDragEnd,
          onColumnDragOver,
          onColumnDrop,
          prevMonth,
          nextMonth,
          onCalendarDrop,
          
          // å·¥å…·å‡½å¼
          formatDate,
          formatDateTime,
          formatGanttDate,
          isToday,
          getDueDateClass,
          getLabelName,
          getColumnColor,
          getCardsInColumn,
          getCardsOnDate,
          getChecklistProgress,
          getChecklistCompleted,
          getGanttBarStyle
        };
      }
    }).mount('#app');
  </script>
</body>
</html>
